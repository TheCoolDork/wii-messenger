name: Build GRRLIB with FreeType for Wii

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§¹ Checkout repo
        uses: actions/checkout@v3

      - name: ğŸ’½ Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git build-essential autoconf automake libtool pkg-config

      - name: ğŸ› ï¸ Install DevKitPro toolchain (Wii)
        run: |
          wget https://apt.devkitpro.org/install-devkitpro-pacman
          chmod +x install-devkitpro-pacman
          sudo ./install-devkitpro-pacman
          sudo dkp-pacman -Sy
          sudo dkp-pacman -S --noconfirm devkitPPC wii-dev

      - name: ğŸ” Clone FreeType
        run: |
          git clone https://gitlab.freedesktop.org/freetype/freetype.git
          cd freetype
          ./autogen.sh || true  # Skip if already present
          ./configure --host=powerpc-eabi --prefix=/opt/devkitpro/portlibs/wii
          make -j$(nproc)
          sudo make install

      - name: ğŸ¨ Clone and Build GRRLIB
        run: |
          git clone https://github.com/GRRLIB/GRRLIB.git
          cd GRRLIB
          make -j$(nproc)
          sudo make install

      - name: ğŸ“¦ Upload GRRLIB build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: GRRLIB-wii-build
          path: |
            /opt/devkitpro/portlibs/wii/lib/libgrrlib.a
            /opt/devkitpro/portlibs/wii/include/grrlib/

  build-dol:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ğŸ§¹ Checkout wii-messenger
        uses: actions/checkout@v3

      - name: ğŸ’½ Install DevKitPro toolchain
        run: |
          wget https://apt.devkitpro.org/install-devkitpro-pacman
          chmod +x install-devkitpro-pacman
          sudo ./install-devkitpro-pacman
          sudo dkp-pacman -Sy
          sudo dkp-pacman -S --noconfirm devkitPPC wii-dev

      - name: ğŸ—ï¸ Compile Wii Messenger
        run: |
          cd wii-messenger
          make

      - name: ğŸ“¦ Upload .dol artifact
        uses: actions/upload-artifact@v3
        with:
          name: wii-messenger-dol
          path: wii-messenger/wii-messenger.dol